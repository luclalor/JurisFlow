<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JurisFlow MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-xl w-full max-w-2xl overflow-hidden flex flex-col h-[85vh] md:h-[90vh]">
        
        <!-- Header -->
        <header class="bg-indigo-600 text-white p-6 shadow-md">
            <h1 class="text-3xl font-bold rounded-xl">JurisFlow Chat</h1>
            <p class="text-sm mt-1 opacity-80">MVP using Voiceflow & Google Sheets</p>
        </header>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-grow p-6 overflow-y-auto space-y-4">
            <!-- The initial greeting will now come from Voiceflow. -->
        </div>

        <!-- User Input Area -->
        <div class="p-4 bg-gray-50 flex flex-col sm:flex-row items-center border-t border-gray-200 gap-2">
            <input type="text" id="chat-input" placeholder="Type your message..." class="flex-grow p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200 w-full sm:w-auto">
            <button id="send-button" class="bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 transition-colors duration-200 shadow-lg w-full sm:w-auto">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mx-auto">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.769 59.769 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Modal for alerts -->
    <div id="alert-modal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Notification</h3>
            <p id="alert-message" class="text-gray-600 mb-6"></p>
            <button id="alert-close-button" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-full hover:bg-indigo-700 transition-colors">OK</button>
        </div>
    </div>

    <script>
        // These keys and URLs connect your chat UI to the back-end services.
        // You MUST replace these placeholder values with your own keys and URL.
        const VOICEFLOW_API_KEY = "VF.DM.68bc88e78eb7ac9f5272d4d9.lLtlAJdrUFlFqSbi";
        const VOICEFLOW_VERSION_ID = "68bbca1c34792a261adca34d";
        
        const chatContainer = document.getElementById('chat-container');
        const inputField = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const alertCloseButton = document.getElementById('alert-close-button');

        // Dynamically generate a simple user ID for this session
        const userId = "mary@gmail.com"; // For testing purposes

        function addMessageToChat(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'items-start'} space-x-3`;
            messageDiv.innerHTML = `
                <div class="p-4 rounded-xl shadow-sm max-w-xs ${isUser ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'}">
                    ${text.replace(/\n/g, '<br>')}
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showModal(message) {
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }

        alertCloseButton.addEventListener('click', () => {
            alertModal.classList.add('hidden');
        });

        async function sendMessageToVoiceflow(message) {
            try {
                const response = await fetch(`https://general-runtime.voiceflow.com/state/user/ID/interact`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json','Authorization':VOICEFLOW_API_KEY },
                    body: JSON.stringify({
                        action: { type: 'text', payload: message },
                        user: { id: userId },
                        config: { tts: false, stripSSML: true, versionID: VOICEFLOW_VERSION_ID }
                    })
                });
                const data = await response.json();
                
                // Check if the response is a valid array before iterating
                if (Array.isArray(data)) {
                    let botResponse = '';
                    for (const item of data) {
                        if (item.type === 'text') {
                            botResponse += item.payload.message + '\n';
                        }
                    }
                    if (botResponse) {
                        addMessageToChat(botResponse);
                    }
                } else {
                    // Handle cases where the response is not a valid array (e.g., an error object)
                    if (data.error) {
                        showModal(`Error from Voiceflow: ${data.error}`);
                    } else {
                        showModal("An unexpected error occurred with the Voiceflow API. Please check your API keys and version ID.");
                    }
                }
            } catch (error) {
                console.error("Error with Voiceflow API:", error);
                showModal("There was an error connecting to the Voiceflow assistant. Please try again later.");
            }
        }

        sendButton.addEventListener('click', () => {
            const message = inputField.value.trim();
            if (message) {
                addMessageToChat(message, true);
                sendMessageToVoiceflow(message);
                inputField.value = '';
            }
        });

        inputField.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendButton.click();
            }
        });
        
        // New line to automatically start the chat
        window.onload = () => sendMessageToVoiceflow("start");
    </script>
</body>
</html>
