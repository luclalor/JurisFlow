<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JurisFlow MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .active-tab-content { display: block; }
    </style>
    <!-- Firebase Imports for Database and Auth -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase objects globally for use in the main script block
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, setDoc, getDoc, collection, query, where, onSnapshot
        };
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-xl w-full max-w-2xl overflow-hidden flex flex-col h-[85vh] md:h-[90vh]">
        
        <!-- Header -->
        <header class="bg-indigo-600 text-white p-4 shadow-md flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">JurisFlow Assistant</h1>
                <p id="user-display" class="text-xs mt-1 opacity-80"></p>
            </div>
            <div id="loading-spinner" class="hidden">
                <div class="w-6 h-6 border-4 border-white border-t-indigo-300 rounded-full animate-spin"></div>
            </div>
        </header>

        <!-- Tabs -->
        <div class="flex border-b border-gray-200">
            <button class="tab-button flex-1 p-3 text-center font-medium text-gray-700 bg-white hover:bg-gray-100 transition-colors duration-200 border-r border-indigo-600/20 active-tab" data-tab="chat">Chat</button>
            <button class="tab-button flex-1 p-3 text-center font-medium text-gray-700 bg-white hover:bg-gray-100 transition-colors duration-200" data-tab="settings">Profile Settings</button>
        </div>

        <!-- Content Area -->
        <div class="flex-grow overflow-y-auto">
            <!-- Chat Tab -->
            <div id="chat" class="tab-content active-tab-content flex flex-col h-full">
                <div id="chat-container" class="flex-grow p-4 overflow-y-auto space-y-4">
                    <!-- Chat messages go here -->
                </div>
                <!-- User Input Area -->
                <div class="p-4 bg-gray-50 flex flex-col sm:flex-row items-center border-t border-gray-200 gap-2">
                    <input type="text" id="chat-input" placeholder="Type your message..." class="flex-grow p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200 w-full sm:w-auto">
                    <button id="send-button" class="bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 transition-colors duration-200 shadow-lg w-full sm:w-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mx-auto">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.769 59.769 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Personal Billable Profile</h2>
                <p class="text-sm text-gray-600 mb-6">Define your targets and thresholds. This data is private to you and used to generate custom utilization alerts.</p>
                <form id="profile-form" class="space-y-4">
                    <div>
                        <label for="annualTarget" class="block text-sm font-medium text-gray-700 mb-1">Annual Billable Target (Hours)</label>
                        <input type="number" id="annualTarget" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="weeklyMaxThreshold" class="block text-sm font-medium text-gray-700 mb-1">Weekly "Too Much" Threshold (Hours)</label>
                        <input type="number" id="weeklyMaxThreshold" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                        <p class="text-xs text-gray-500 mt-1">Example: 60 hours. Alerts you for potential burnout.</p>
                    </div>
                    <div>
                        <label for="weeklyMinThreshold" class="block text-sm font-medium text-gray-700 mb-1">Weekly "Too Little" Threshold (Hours)</label>
                        <input type="number" id="weeklyMinThreshold" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                        <p class="text-xs text-gray-500 mt-1">Example: 30 hours. Alerts you for underutilization risk.</p>
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white font-semibold py-3 rounded-xl hover:bg-green-600 transition-colors duration-200">
                        Save Profile Settings
                    </button>
                    <p id="settings-status" class="text-center mt-3 text-sm"></p>
                </form>
            </div>
        </div>

        <!-- Modal for alerts -->
        <div id="alert-modal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Notification</h3>
                <p id="alert-message" class="text-gray-600 mb-6"></p>
                <button id="alert-close-button" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-full hover:bg-indigo-700 transition-colors">OK</button>
            </div>
        </div>
    </div>
    
    <script>
        // Ensure firebase object is available after the module loads
        if (typeof window.firebase === 'undefined') {
            console.error("Firebase module failed to load.");
        }

        // Global variables provided by the Canvas environment (MUST BE USED)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Voiceflow Configuration
        const VOICEFLOW_API_KEY = "YOUR_VOICEFLOW_API_KEY_HERE";
        const VOICEFLOW_VERSION_ID = "YOUR_VOICEFLOW_VERSION_ID_HERE";
        
        // DOM Elements
        const chatContainer = document.getElementById('chat-container');
        const inputField = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const alertCloseButton = document.getElementById('alert-close-button');
        const userDisplay = document.getElementById('user-display');
        const loadingSpinner = document.getElementById('loading-spinner');
        const profileForm = document.getElementById('profile-form');
        const settingsStatus = document.getElementById('settings-status');

        // Firebase Instances & State
        let db, auth, currentUserId = null;
        let isAuthReady = false;

        // --- Utility Functions ---

        function showLoading(show) {
            if (show) {
                loadingSpinner.classList.remove('hidden');
                sendButton.disabled = true;
                inputField.disabled = true;
            } else {
                loadingSpinner.classList.add('hidden');
                sendButton.disabled = false;
                inputField.disabled = false;
            }
        }

        function addMessageToChat(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'items-start'} space-x-3`;
            messageDiv.innerHTML = `
                <div class="p-4 rounded-xl shadow-sm max-w-xs ${isUser ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'}">
                    ${text.replace(/\n/g, '<br>')}
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showModal(message) {
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }

        // --- Tab Switching Logic ---
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active classes from all buttons and content
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active-tab', 'border-indigo-600'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active-tab-content'));

                // Add active classes to the clicked button and its content
                button.classList.add('active-tab', 'border-indigo-600');
                document.getElementById(button.dataset.tab).classList.add('active-tab-content');
            });
        });

        alertCloseButton.addEventListener('click', () => {
            alertModal.classList.add('hidden');
        });

        // --- Voiceflow/Chat Logic ---

        async function sendMessageToVoiceflow(message) {
            showLoading(true);
            try {
                const response = await fetch(`https://general-runtime.voiceflow.com/v2/interact/api?api_key=${VOICEFLOW_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: { type: 'text', payload: message },
                        user: { id: currentUserId }, // Use the authenticated user ID
                        config: { tts: false, stripSSML: true, versionID: VOICEFLOW_VERSION_ID }
                    })
                });
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    let botResponse = '';
                    for (const item of data) {
                        if (item.type === 'text') {
                            botResponse += item.payload.message + '\n';
                        }
                    }
                    if (botResponse) {
                        addMessageToChat(botResponse);
                    }
                } else if (data.error) {
                    showModal(`Error from Voiceflow: ${data.error}`);
                } else {
                    showModal("An unexpected error occurred with the Voiceflow API.");
                }
            } catch (error) {
                console.error("Error with Voiceflow API:", error);
                showModal("There was an error connecting to the Voiceflow assistant.");
            } finally {
                showLoading(false);
            }
        }

        sendButton.addEventListener('click', () => {
            const message = inputField.value.trim();
            if (message && isAuthReady) {
                addMessageToChat(message, true);
                sendMessageToVoiceflow(message);
                inputField.value = '';
            } else if (!isAuthReady) {
                 showModal("Please wait for authentication to complete before sending a message.");
            }
        });

        inputField.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent new line in input field
                sendButton.click();
            }
        });
        
        // --- Firebase Setup and Auth ---

        async function setupFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                return;
            }
            
            showLoading(true);
            
            try {
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.getFirestore(app);
                auth = firebase.getAuth(app);

                // Set Firestore logging to debug
                firebase.setLogLevel('Debug');
                
                // Sign in using the custom token or anonymously
                if (initialAuthToken) {
                    await firebase.signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await firebase.signInAnonymously(auth);
                }

                // Wait for auth state to be established
                firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userDisplay.textContent = `User ID: ${currentUserId}`;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. User ID:", currentUserId);
                        
                        // 1. Start Chat interaction only after auth
                        sendMessageToVoiceflow("");

                        // 2. Start listening for user profile data
                        listenForUserProfile(currentUserId);
                    } else {
                        // This should not happen if signInAnonymously is successful
                        console.error("Authentication failed: No user found.");
                        isAuthReady = false;
                        showModal("Authentication failed. Cannot connect to services.");
                    }
                    showLoading(false);
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showModal("Failed to connect to the backend services.");
                showLoading(false);
            }
        }

        // --- User Profile (Settings) Logic ---
        const USER_PROFILES_PATH = `/artifacts/${appId}/users/`;
        const PROFILE_DOC_NAME = 'settings';

        /**
         * Listens to the user's profile document in Firestore and updates the form.
         * @param {string} userId - The authenticated user's UID.
         */
        function listenForUserProfile(userId) {
            const profileRef = firebase.doc(db, USER_PROFILES_PATH, userId, 'user_profiles', PROFILE_DOC_NAME);
            
            firebase.onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('annualTarget').value = data.annualTarget || '';
                    document.getElementById('weeklyMaxThreshold').value = data.weeklyMaxThreshold || '';
                    document.getElementById('weeklyMinThreshold').value = data.weeklyMinThreshold || '';
                    settingsStatus.textContent = "Profile loaded successfully.";
                    settingsStatus.className = "text-center mt-3 text-sm text-green-600";
                } else {
                    settingsStatus.textContent = "Welcome! Please set up your billable profile.";
                    settingsStatus.className = "text-center mt-3 text-sm text-indigo-600";
                }
            }, (error) => {
                console.error("Error listening to user profile:", error);
                settingsStatus.textContent = "Error loading profile data.";
                settingsStatus.className = "text-center mt-3 text-sm text-red-600";
            });
        }

        /**
         * Saves the form data to the user's private Firestore profile document.
         */
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !db) {
                showModal("Authentication is not ready. Please try again in a moment.");
                return;
            }

            const annualTarget = parseFloat(document.getElementById('annualTarget').value);
            const weeklyMaxThreshold = parseFloat(document.getElementById('weeklyMaxThreshold').value);
            const weeklyMinThreshold = parseFloat(document.getElementById('weeklyMinThreshold').value);

            if (isNaN(annualTarget) || isNaN(weeklyMaxThreshold) || isNaN(weeklyMinThreshold)) {
                showModal("Please enter valid numbers for all target fields.");
                return;
            }
            
            const profileData = {
                annualTarget: annualTarget,
                weeklyMaxThreshold: weeklyMaxThreshold,
                weeklyMinThreshold: weeklyMinThreshold,
                lastUpdated: new Date()
            };

            try {
                const profileRef = firebase.doc(db, USER_PROFILES_PATH, currentUserId, 'user_profiles', PROFILE_DOC_NAME);
                await firebase.setDoc(profileRef, profileData, { merge: true });
                settingsStatus.textContent = "Profile settings saved successfully!";
                settingsStatus.className = "text-center mt-3 text-sm text-green-600 font-bold";
            } catch (error) {
                console.error("Error saving user profile:", error);
                settingsStatus.textContent = "Error saving profile. Check console for details.";
                settingsStatus.className = "text-center mt-3 text-sm text-red-600 font-bold";
            }
        });


        // --- Initialize Application ---
        window.onload = setupFirebase;
    </script>
</body>
</html>
